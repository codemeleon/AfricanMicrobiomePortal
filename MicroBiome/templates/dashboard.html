{% comment %} {% extends "mainLayout.html" %} {% endcomment %}
{% load leaflet_tags %}
{% comment %}  {% endcomment %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/>
<style>
#map {  /* all maps */
		width:  100%;
		height: 850px;
    	background-color: #D7F2FE;/*#CFEFFD;*/
}
}
</style>
{% endblock %}

{% block js_top %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="http://leaflet-extras.github.io/leaflet-providers/leaflet-providers.js"></script>
<script type="text/javascript" src="{% static "js/BoundaryCanvas.js" %}"></script>
{% endblock %}

{% block content %}

{% comment %} <h1>African Microbiome Portal Dashboard</h1> {% endcomment %}
{% comment %} https://medium.com/wdstack/bootstrap-4-chart-js-39006427f08f {% endcomment %}
{% comment %} TODO: Need to change it to mobile friendly {% endcomment %}
{% comment %} <div class="container"> {% endcomment %}
	<div class="card mt-4 text-center"><H1>PORTAL DATA OVERVIEW</H1></div>
	<br />

	<div class="container">
    <div class="row">
        <div class="col-sm-6 pr-0">
            <div class="card">
                <div class="card-body">
                    <div id="body_site"></div>
                </div>
            </div>
        </div>
				<div class="col-sm-6 pl-0">
            <div class="card">
                <div class="card-body">
                    <div id="assay_type"></div>
                </div>
            </div>
        </div>
     </div>

		<div class="row">
        <div class="col-sm-6 pr-0">
            <div class="card">
                <div class="card-body">
                    <div id="disease"></div>
                </div>
            </div>
        </div>
				<div class="col-sm-6 pl-0">
            <div class="card">
                <div class="card-body">
                    <div id="platform"></div>
                </div>
            </div>
        </div>
     </div>

		<div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
									<h4 align="center">Sample collection locations</h4>
                    <div id="map"></div>
                </div>
            </div>
				</div>
		 </div>

	</div>


{% comment %} BODY SITE {% endcomment %}

<script>
		site_pie_dict = {{site_pie_dict|safe}};
		
		{% comment %} TODO: Need to integrate link from server side. as https://stackoverflow.com/questions/16176390/highcharts-provide-urls-for-series-data-to-open-clickable-link {% endcomment %}
		Highcharts.chart('body_site', {
				chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				options3d: {
						enabled: true,
						alpha: 45
				}
		},
		title: {
				text: 'Studies by Body Site'
		},
		subtitle: {
				text: ''
		},tooltip: {
			hideDelay:10000,
			useHTML:true,
			style: {
              			padding: 0,
              			pointerEvents: 'auto'
              		},
			formatter:function(){
                       		var pcnt = this.point.percentage;
                        	pcnt=Highcharts.numberFormat(pcnt)+'%';
                        	return '<a href="/microbiome/results/?tags=' + this.point.name +'"/>' + this.point.name + ': ' + pcnt + '</a>';
			}
		/*pointFormat: '<a href="/microbiome/results/?tags={point.name}">{point.name}:{point.percentage:.1f}</a>' */
		},
		plotOptions: {
				pie: {
						allowPointSelect: true,
						cursor: 'pointer',
						dataLabels: {
								enabled: false
						},
						showInLegend: true,
						innerSize: 100,
						depth: 45
				}
		},
		series: [{
						name: 'Body site',
						data: site_pie_dict
		}],
		credits: {
						enabled: false
		},
		});
</script>

{% comment %} ASSAY TYPE {% endcomment %}

<script>
	xdata_assay = {{xdata_assay|safe}};
	ydata_assay = {{ydata_assay|safe}};
	
	var ydata_assay_sum=0;
	for (var i=0; i<ydata_assay.length; i++){
		ydata_assay_sum+=ydata_assay[i] 
	}
	Highcharts.chart('assay_type', {
	chart: {
					type: 'column'
	},
	title: {
					text: 'Studies by Assay Type'
	},
	xAxis: {
					categories:xdata_assay,
					crosshair: true
	},
	yAxis: {
					min: 0,
					title: {
			text: 'Number of Samples'
					}
	},
	tooltip: {
		hideDelay: 10000,
		useHTML: true,
		style: {
			padding: 0,
			pointerEvents: 'auto'
		},
		formatter:function(){	
			var pcnt = (this.y/ydata_assay_sum)*100;
			pcnt=Highcharts.numberFormat(pcnt)+'%';
			return '<a href="/microbiome/results/?tags=' + this.x +'"/>' + this.x + ': ' + pcnt + '</a>';
	
		}
	},	
	plotOptions: {
					column: {
			pointPadding: 0.2,
			borderWidth: 0
		}
	},
	series: [{
					showInLegend: false,
					name: 'Assay type',
					data: ydata_assay

	}],
	credits: {
					enabled: false
	},

	});
	</script>


 {% comment %} DISEASE {% endcomment %}

<script>
		xdata_disease = {{xdata_disease|safe}};
		ydata_disease = {{ydata_disease|safe}};
		
		var ydata_disease_sum=0;
		for (var i=0; i<ydata_disease.length; i++){
			ydata_disease_sum+=ydata_disease[i] 
		}		

		Highcharts.chart('disease', {
		chart: {
						type: 'column'
		},
		title: {
						text: 'Studies by Disease/Condition'
		},
		xAxis: {
						categories:xdata_disease,
						crosshair: true
		},
		yAxis: {
						min: 0,
						title: {
				text: 'Number of Studies'
						}
		},
	 tooltip: {
		hideDelay: 10000,
		useHTML: true,
		style: {
			padding: 0,
			pointerEvents: 'auto'
		},
	formatter:function(){	
		var pcnt = (this.y/ydata_disease_sum)*100;
		pcnt=Highcharts.numberFormat(pcnt)+'%';
		return '<a href="/microbiome/results/?tags=' + this.x +'"/>' + this.x + ': ' + pcnt + '</a>';
	}
	/* pointFormat: '<a href="http://google.com">Clickable link {point.name}</a>' */
							},
		plotOptions: {
						column: {
				pointPadding: 0.2,
				borderWidth: 0
			}
		},
		series: [{
						showInLegend: false,
						name: 'Disease/Condition',
						data: ydata_disease

		}],
		credits: {
						enabled: false
		},
		});
		</script>



{% comment %} PLAFORM {% endcomment %}



<script>
		platform_pie_dict = {{platform_pie_dict|safe}};
		Highcharts.chart('platform', {
				chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				options3d: {
						enabled: true,
						alpha: 45
				}
		},
		title: {
				text: 'Studies by Sequencing Platform'
		},
		subtitle: {
				text: ''
		},
		{% comment %}   tooltip: { {% endcomment %}
		{% comment %}     pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>' {% endcomment %}
		{% comment %} }, {% endcomment %}
			tooltip: {
                  hideDelay: 10000,
                  useHTML: true,
                  style: {
                    padding: 0,
                    pointerEvents: 'auto'
                  },

		formatter:function(){
                                var pcnt = this.point.percentage;
                                pcnt=Highcharts.numberFormat(pcnt)+'%';
                                return '<a href="/microbiome/results/?tags=' + this.point.name +'"/>' + this.point.name + ': ' + pcnt + '</a>';
                        }

/*     pointFormat:'<a href="/microbiome/results/?tags={point.name}">{point.name}:{point.percentage:.1f}</a>',*/
                },
		plotOptions: {
				pie: {
						allowPointSelect: true,
						cursor: 'pointer',
						dataLabels: {
								enabled: false
						},
						showInLegend: true,
						innerSize: 100,
						depth: 45
				}
		},
		series: [{
						name: 'Platform',
						data: platform_pie_dict
		}],
		credits: {
						enabled: false
		},
		});
</script>

{% for spot in all_records %}
	{% if spot.lat == None %}
		{{spot.lat }}
		{% endif %}
{% endfor %}

 <script type="text/javascript">
		
		var map = L.map('map').setView([7.96608951118329,9.08467529987021], 4);
        
        var geom = {"type":"Polygon","coordinates":[
    	[
        [-6.0645,35.6037],
        [-8.7891,33.1376],
        [-9.7559,30.6757],
        [-10.7227,28.9216],
        [-13.0078,27.8391],
        [-14.3262,26.037],
        [-15.7324,23.9662],
        [-16.875,21.2075],
        [-16.084,18.7295],
        [-16.2598,16.4677],
        [-17.1387,14.6899],
        [-16.7871,12.5546],
        [-15.0293,10.9196],
        [-12.6563,7.711],
        [-7.7344,4.4779],
        [-2.9883,5.0034],
        [0.791,5.7034],
        [4.1309,6.49],
        [5.8008,4.3902],
        [8.5254,4.4779],
        [10.0195,2.1089],
        [9.0527,-0.6152],
        [9.5801,-2.2846],
        [12.3047,-5.9658],
        [13.4473,-8.7548],
        [13.7988,-11.8674],
        [11.4258,-16.8045],
        [14.2383,-22.4313],
        [15.6445,-28.6135],
        [18.1055,-32.1012],
        [20.2148,-34.597],
        [26.1914,-34.0162],
        [29.3555,-31.9522],
        [31.8164,-28.9216],
        [33.0469,-26.116],
        [35.332,-24.5271],
        [34.8047,-20.7972],
        [37.2654,-17.4764],
        [40.6055,-14.9448],
        [40.6055,-10.3149],
        [39.0234,-6.6646],
        [41.1328,-1.9332],
        [45.3516,2.2846],
        [49.043,6.6646],
        [51.5039,11.6953],
        [44.6484,10.8333],
        [42.8906,11.8674],
        [39.7266,15.4537],
        [38.6719,18.3128],
        [37.793,18.6462],
        [36.9141,22.106],
        [35.8594,23.0197],
        [33.5142,27.6835],
        [34.1016,27.8391],
        [34.4531,31.3536],
        [32.3438,31.5036],
        [30.4102,31.8029],
        [29.5313,30.9022],
        [25.3125,31.3536],
        [21.4453,32.8427],
        [20.2143,32.1012],
        [20.0391,30.9022],
        [19.5117,30.4487],
        [16.6992,31.5036],
        [15.6445,31.9522],
        [11.7773,33.2846],
        [10.8984,34.0162],
        [10.1953,34.1618],
        [11.25,34.597],
        [11.0742,35.7465],
        [11.0742,36.5979],
        [10.0195,37.44],
        [9.3164,37.1603],
        [7.5586,36.8796],
        [5.4492,36.8796],
        [1.9336,37.1603],
        [0.7031,36.4566],
        [-1.17578,35.3174],
        [-3.8672,35.1738],
        [-5.4492,36.3151],
        [-5.9766,36.0313],
        [-5.9766,35.6037],
        [-6.1523,34.7416],
        [-7.207,34.8859]
	    ]
	    ]};

		osmUrl='https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}.png';
		osmAttribution='Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community';

		var osm = L.TileLayer.boundaryCanvas(osmUrl, {
		    boundary: geom, 
		    attribution: osmAttribution
		}).addTo(map);

     	{% for spot in records.itertuples %}
			var lon = "{{ spot.lat }}";
			var lat = "{{ spot.lon }}";
			// zoom to point & add it to map
			var marker = L.marker([lat, lon]);
			// var marker = L.marker([lat, lon]).addTo(map);
			var list = "<Strong>Condition: </Strong>" + "<a href='/microbiome/results/?tags={{spot.disease }}'>{{ spot.disease }}</a>" + "<br />"
				+ "<Strong>Platform: </Strong>" + "<a href='/microbiome/results/?tags={{spot.platform}}'>{{ spot.platform }}</a>" + "<br />"
				+ "<Strong>Sample type: </Strong>" + "<a href='/microbiome/results/?tags={{spot.sample_type }}'>{{ spot.sample_type }}</a>" + "<br />"
			       + "<Strong>Sample count: </Strong>" + "{{ spot.sample_number }}" + "<br />"
			+ "<Strong>Country: </Strong>" + "<a href='/microbiome/results/?tags={{spot.country }}'>{{ spot.country }}</a>" + "<br />"
              //marker.setContent(list).openPopup();
        	marker.bindPopup(list).addTo(map);
          	// .openPopup();
        {% endfor %}
  </script>

{% endblock %}
